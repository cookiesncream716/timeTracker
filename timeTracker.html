<head>
    <meta charset="utf-8" />
</head>
<body></body>
<script src="node_modules/proto/dist/proto.umd.js"></script>
<script src="node_modules/gem/dist/Gem.umd.js"></script>
<link rel="stylesheet" type="text/css" href="node_modules/flatpickr/dist/flatpickr.min.css">
<script src="node_modules/flatpickr/dist/flatpickr.min.js"></script>
<script src="https://tixit.me/ExtensionTester.umd.js"></script>
<script>
	var TimeTracker = proto(Gem, function(superclass){
		this.name = 'TimeTracker'
		this.build = function(ticket, optionsObservee, api){
			var that = this
			this.ticket = ticket
			optionsObservee = {subject:optionsObservee} // todo: remove this when Tixit is deployed next
			var inProperty = optionsObservee.subject.checkInField
			// var start = ticket.subject[inProperty]
			// var start = ticket.get(inProperty).subject
			api.User.current().then(function(user){
				that.currUser = user.subject._id
			}).done()
			console.log(this.currUser)

			this.checkIn = Gem.TextField()
			this.mIn
			if(ticket.get(inProperty).subject === undefined){
				this.checkIn.val = new Date()
				// this.mIn = new Date(this.checkIn.val).getTime()
				// ticket.set('checkIn', this.checkIn.val)
				this.setIn()
				var fp_in = new flatpickr(this.checkIn.domNode, {
					enableTime: true,
					dateFormat: 'm-d-Y h:i K',
					defaultDate: new Date(),
					// maxDate: 'today',
					minuteIncrement: 1,
					onClose: function(){
						// var x = that.checkIn.val
						// that.mIn = new Date(x).getTime()
						// console.log('mIn = ' + that.mIn)
						that.setIn()
					}
				})
			} else{
				this.checkIn.val = ticket.get(inProperty).subject
				// this.mIn = new Date(start).getTime()
				// ticket.set('checkIn', this.checkIn.val)
				this.setIn()
				var fp_in = new flatpickr(this.checkIn.domNode, {
					enableTime: true,
					dateFormat: 'm-d-Y h:i K',
					defaultDate: ticket.get(inProperty).subject,
					minuteIncrement: 1,
					onClose: function(){
						// var x = that.checkIn.val
						// that.mIn = new Date(x).getTime()
						that.setIn()
					}
				})
			}

			var errorMessage = Gem.Text('error', 'x')
			errorMessage.visible = false
			this.checkOut = Gem.TextField()
			var fp_out = new flatpickr(this.checkOut.domNode, {
				enableTime: true,
				// defaultDate: new Date(),
				dateFormat: "m-d-Y h:i K",
				maxDate: 'today',
				minuteIncrement: 1,
				onClose: function(){
					var y = that.checkOut.val
					that.mOut = new Date(y).getTime()
					if(y == '' || that.mOut < that.mIn){
						errorMessage.text = 'Your End Time must be later than your Start Time'
						errorMessage.visible = true
						that.checkOut.val = ''
					} else{
						errorMessage.visible = false
						that.calculateTime()
					}
				}
			})

			this.workedText = Gem.Text()
			this.workedText.visible = false
			var box = Gem.Text('div', 'Keep track of the time you are working.')
			var box2 = Gem.Block('div', Gem.Text('Start Time: '), this.checkIn, Gem.Text(' End Time: '), this.checkOut, errorMessage, this.workedText)
			box.visible = false
			box2.visible = false
			var button = Gem.Button('timeTracker')
			this.add(button, box, box2)

			button.on('click', function(){
				box.visible = true
				box2.visible = true
				// does button need to be hidden or maybe moved
			})
		}

		this.setIn = function(){
			var ms = this.checkIn.val
			this.mIn = new Date(ms).getTime()
			this.ticket.set('checkIn', this.checkIn.val)
		}
		this.calculateTime = function(){
			console.log('in ' + this.mIn + ' out ' + this.mOut)
			var diff = this.mOut - this.mIn
			console.log('diff ' + diff)
			var hours = Math.floor(diff/1000/60/60)
			diff -= hours*1000*60*60
			var minutes = Math.floor(diff/1000/60)
			console.log('hours = ' + hours + ' minutes = ' + minutes)
			this.workedText.text = 'You worked ' + hours + ' hours and ' + minutes + ' minutes.'
			this.workedText.visible = true
			this.ticket.set('checkOut', this.checkOut.val)
			// timeWorked is in milliseconds so need to do math to convert to hours/minutes when displayed
			this.ticket.set('timeWorked', diff)
			this.ticket.set('user', this.currUser)
		}
		this.getStyle = function(){
			return Gem.Style({
				$div: {
					display: 'block'
				},
				$error: {
					color: 'red',
					display: 'block'
				}
			})
		}

	})
	ExtensionTester.Api.Ticket.create().then(function(newOne){
		// newOne.subject.checkIn = new Date(2017, 7, 16, 5, 30)
		ExtensionTester(TimeTracker, {checkInField: 'checkIn', checkOutField: 'checkOut', timeWorkedField: 'timeWorked', userField: 'user'}, {ticketId: newOne.subject._id, showEditor: true})
	}).done()
</script>